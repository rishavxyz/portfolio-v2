---
import { Fdate, SuperImg } from "$lib/components";
import { dev } from "$lib/env";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { cn } from "$lib/utils";

type Props = {
  loading?: "lazy" | "eager";
  class?: string;
};

const { loading, class: cls } = Astro.props;

const getPosts = await getCollection("blog");
function sortPosts(posts: CollectionEntry<"blog">[]) {
  const filterDraftPosts = posts.filter((post) =>
    dev ? post : post.data.draft != true,
  );
  const sortedPosts = filterDraftPosts.sort(
    (fst, snd) => snd.data.pubon.getTime() - fst.data.pubon.getTime(),
  );

  return sortedPosts;
}
const blogs = sortPosts(getPosts);
---

<ul id="blogs" class={"[&>li+li]:border-t " + cn(cls)}>
  {
    blogs.map((d, i) => (
      <li class="border-muted-light md:border-none">
        <a
          href={`/blog/${d.slug}`}
          class="group grid grid-cols-[var(--space-sm)_1fr_var(--space-sm)] grid-rows-[1fr_var(--space-md)_auto]"
          data-astro-prefetch
        >
          {d.data.img && (
            <figure class="[grid-column:2/4] [grid-row:1/3] mt-md md:mt-0 rounded overflow-hidden">
              <SuperImg
                src={d.data.img}
                loading={loading || i <= 3 ? "eager" : "lazy"}
                alt={`Thumbnail of the post ${d.data.title}`}
                width={540}
              />
            </figure>
          )}
          <div class="[grid-column:1/3] [grid-row:2/4] bg-white text-black rounded-tr pe-sm ps-0 pb-0 pt-sm">
            <p class="font-semibold text-lg leading-snug group-hover:underline">
              {d.data.title}
            </p>
            <Fdate
              date={d.data.pubon}
              class="block my-1 text-sm text-muted-dark"
            />
            <p>{d.data.desc}</p>
          </div>
        </a>
      </li>
    ))
  }
</ul>

<style>
  a[href] {
    text-decoration: none;
  }
  #blogs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(320px, 100%), 1fr));
    gap: theme(spacing.md);
  }
</style>
