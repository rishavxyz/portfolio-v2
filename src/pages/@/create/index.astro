---
export const prerender = false;

import MetaFields from "$lib/layouts/content/metaFields.svelte";
import { Layout } from "$lib/layouts";
import { supabase } from "$lib/server/supabase";

const access_token = Astro.cookies.get("sb-access_token");
const refresh_token = Astro.cookies.get("sb-refresh_token");

if (!access_token || !refresh_token) {
  return Astro.redirect("/@/auth");
}

const { data, error } = await supabase.auth.setSession({
  access_token: access_token.value,
  refresh_token: refresh_token.value
});

if (error) {

  Astro.cookies.delete("sb-access_token", {
    path: "/"
  });

  Astro.cookies.delete("sb-refresh_token", {
    path: "/"
  });

  return Astro.redirect("/@/auth");
}
---

<Layout class="px-0">
  <a href="/@" class="underline px-1 block mb-1">Back to dashboard</a>
  <MetaFields client:load />
</Layout>
